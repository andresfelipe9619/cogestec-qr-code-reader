<!DOCTYPE html>
<html>
  <head>
    <title>QR Reader</title>
    <base target="_top" />
    <meta http-equiv="Content-Security-Policy" content="connect-src http:" />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.3/semantic.min.css"
    />
    <script
      type="text/javascript"
      src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"
    ></script>
    <style>
      form {
        display: none;
      }
      #navbar {
        margin-bottom: 60px;
      }

      #pay-info {
        display: none;
      }

      #main-content {
        margin-top: 60px;
      }

      .logo {
        padding-bottom: 3px;
      }

      input:not([name="correo"]) {
        text-transform: uppercase;
      }

      input[name="correo"] {
        text-transform: lowercase;
      }

      ::placeholder {
        text-transform: none;
      }
    </style>
  </head>

  <body>
    <div id="navbar" class="ui fixed inverted menu blue">
      <div class="ui container">
        <img
          class="logo"
          src="http://www.cogestec.co/wp-content/uploads/2018/11/Logo-3.png"
          width="180px"
          height="90px"
        />
        <h3 class="header item">&nbsp;&nbsp;INGRESO EVENTO COGESTEC 2019</h3>
      </div>
    </div>

    <div id="main-content" class="ui grid">
      <div class="six wide column">
        <video id="preview"></video>
        <h2 id="output"></h2>
      </div>
      <div class="eight wide column">
        <form class="ui form attached fluid segment" id="form-form">
          <h4 class="ui dividing header">Información General</h4>
          <div class="field">
            <div class="two fields">
              <div class="field">
                <label>NÚMERO DE CÉDULA</label>
                <input
                  class="numeric"
                  name="cedula"
                  placeholder="Numero de documento"
                  type="text"
                />
              </div>
              <div class="field">
                <label>PAIS</label>
                <input
                  name="pais"
                  placeholder="Numero de documento"
                  type="text"
                />
              </div>
            </div>
          </div>

          <div class="field">
            <div class="two fields">
              <div class="field">
                <label>NOMBRES</label>
                <input name="nombres" placeholder="Nombres" type="text" />
              </div>
              <div class="field">
                <label>APELLIDOS</label>
                <input name="apellidos" placeholder="Apellidos" type="text" />
              </div>
            </div>
          </div>

          <div class="fields">
            <div class="twelve wide field">
              <label>CORREO ELECTRÓNICO</label>
              <input
                name="correo"
                placeholder="Correo Electronico"
                type="text"
              />
            </div>
            <div class="four wide field">
              <label>TÉLEFONO CELULAR</label>
              <input
                name="telefono"
                class="numeric"
                placeholder="Telefono"
                type="text"
              />
            </div>
          </div>
          <div class="two fields">
            <div class="field">
              <label>CONCEPTO DE PAGO</label>
              <input
                name="concepto_pago"
                placeholder="Concepto de pago"
                type="text"
              />
            </div>
            <div class="field">
              <label>PAGO TOTAL</label>
              <input
                name="pago_total"
                class="numeric"
                placeholder="Pago Total "
                type="text"
              />
            </div>
          </div>
          <div class="field">
            <div class="two fields">
              <div class="field">
                <label>PAGO COMPROBADO</label>
                <input
                  name="pago_comprobado"
                  placeholder="pago_comprobado"
                  type="text"
                />
              </div>
              <div class="field">
                <label>DOCUMENTO VERIFICADO</label>
                <input
                  name="documento_verificado"
                  placeholder="documento_verificado"
                  type="text"
                />
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.js"></script>
    <script type="text/javascript">
      $(document).ready(() => {
        // setTimeout(() => {
        //   searchForPerson("1144196063");
        // }, 2000);
        initScanner();
      });

      function initScanner() {
        let scanner = new Instascan.Scanner({
          video: document.getElementById("preview"),
          mirror: false
        });
        scanner.addListener("scan", function(content) {
          $("#output").html(content);
          if (content) {
            searchForPerson(content);
          }
        });
        Instascan.Camera.getCameras()
          .then(function(cameras) {
            if (cameras.length > 0) {
              var selectedCam = cameras[0];
              $.each(cameras, (i, c) => {
                if (c.name.indexOf("back") != -1) {
                  selectedCam = c;
                  return false;
                }
              });
              scanner.start(selectedCam);
            } else {
              $("#output").html("No cameras found.");
              console.error("No cameras found.");
            }
          })
          .catch(function(e) {
            $("#output").html("No cameras found.");
            console.error(e);
          });
      }

      function searchForPerson(content) {
        hideForm();
        let onSuccess = function(result) {
          let person = JSON.parse(result);
          if (person) {
            $("#form-form").addClass("loading");
            $("input[name='cedula']").addClass("not-allowed");

            if (person.isRegistered) {
              showForm();
              showPersonInForm(person);
            } else {
              $("#output").html("Usuario no encontrado!");
              $("#form-form").removeClass("loading");
            }
          } else {
            console.log("Something went wrong searching user...");
          }
        };

        let cedula = content;
        if (cedula.length > 0) {
          google.script.run.withSuccessHandler(onSuccess).searchPerson(cedula);
        } else {
          $("#search-msg").html("Por favor ingrese una cedula");
          $("#search-msg").css("display", "block");
          setTimeout(function() {
            $("#search-msg").html("Por favor ingrese una cedula");
            $("#search-msg").css("display", "none");
          }, 3000);
        }
      }

      function showPersonInForm(person) {
        loadPersonInForm(person);

        disableFormFielfds(true);
        $("#pls-wait").addClass("not-visible");
        $("#form-form").removeClass("loading");
      }
      function loadPersonInForm(person) {
        console.log("Person in form", person);
        personIndex = Number(person.index) + 1;
        currentPerson = person.data;
        $("input[name='nombres']").val(person.data.nombres);
        $("input[name='apellidos']").val(person.data.apellidos);
        $("input[name='cedula']").val(person.data.cedula);
        $("input[name='correo']").val(person.data.correo);
        $("input[name='pais']").val(person.data.pais);
        $("input[name='institucion']").val(person.data.institucion);

        $("input[name='telefono']").val(person.data.telefono);
        $("input[name='dependencia']").val(person.data.dependencia);
        $("input[name='concepto_pago']").val(person.data.concepto_pago);
        $("input[name='pago_comprobado']").val(person.data.pago_comprobado);
        $("input[name='documento_verificado']").val(
          person.data.documento_verificado
        );

        $("input[name='pago_total']").val(person.data.pago_total);
        // $(".ui.radio").checkbox();
        if (person.data["acepta_ponencia"].includes("*")) {
          $("input[name=acepta_ponencia]").attr("disabled", true);
        }
        if (person.data["acepta_ponencia"].includes("SI")) {
          $("#ponencia_si").prop("checked", true);
        } else if (person.data["acepta_ponencia"].includes("NO")) {
          $("#ponencia_no").prop("checked", true);
        } else {
          $("#ponencia_fields").addClass("not-visible");
        }
        $(".file-ponencia-field").addClass("not-visible");
      }
      function disableFormFielfds(bool) {
        if (bool) {
          $("input:not([name='busca-cedula'], [type='radio'])").prop(
            "readonly",
            true
          );
          $("input:not([name='busca-cedula'], [type='radio'])").addClass(
            "not-allowed"
          );
        } else {
          $("input:not([name='busca-cedula'])").prop("readonly", false);
          $("input:not([name='busca-cedula'])").removeClass("not-allowed");
        }
      }

      function showForm() {
        $("#form-form").css("display", "block");
        $(".support-ready-field").addClass("not-visible");
        $("ui.submit.button").css("display", "block");
        $("input[name='cedula']").val($("#busca-cedula").val());
        disableFormFielfds(false);
      }

      function hideForm() {
        $("#form-form").css("display", "none");
        $(".fields.regreso").removeClass("not-allowed");
        $(".doc-field").removeClass("not-visible");
        $(".fields.regreso").removeClass("not-allowed");
        $("#digita-ponencia").addClass("not-visible");
        $("#pay-msg").addClass("not-visible");
        $("#pay-msg").text("");
        $("#register-pay-btn").addClass("not-visible");
        $("#free-btn").addClass("not-visible");
        disableFormFielfds(false);
        $("#form-form").form("clear");
      }
    </script>
  </body>
</html>
